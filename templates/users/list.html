{% extends 'base.html' %}

{% block title %}Users - Access Control System{% endblock %}
{% block header_title %}Users{% endblock %}

{% block breadcrumb_items %}
<div class="breadcrumb-item">
    <a href="/" class="breadcrumb-link">Home</a>
</div>
<div class="breadcrumb-item">Users</div>
{% endblock %}

{% block page_title %}Users{% endblock %}
{% block page_description %}Manage users and their permissions{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <div class="search-box">
        <div class="input-group">
            <input type="text" id="searchInput" class="form-control" placeholder="Search users...">
            <button id="searchBtn" class="btn btn-outline-secondary">
                <i data-feather="search"></i>
            </button>
        </div>
    </div>
    <div class="view-actions">
        <button id="listViewBtn" class="btn btn-outline-primary active">
            <i data-feather="list"></i>
        </button>
        <button id="treeViewBtn" class="btn btn-outline-primary">
            <i data-feather="git-merge"></i>
        </button>
        <button id="addUserBtn" class="btn btn-primary ml-2">
            <i data-feather="user-plus" class="btn-icon"></i> Add User
        </button>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <!-- List View (default) -->
        <div id="listView" class="view-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="userTableBody">
                    <tr>
                        <td colspan="4" class="text-center">Loading users...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Tree View (initially hidden) -->
        <div id="treeView" class="view-container" style="display: none;">
            <div class="organization-tree-view">
                <div id="userTreeContainer" class="tree-view">
                    <p>Loading organization hierarchy...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit User Modal -->
<div id="userModal" class="modal">
    <div class="modal-content">
        <span class="modal-close">&times;</span>
        <h3 id="userModalTitle">Add User</h3>
        
        <form id="userForm">
            <input type="hidden" id="userId" value="">
            
            <div class="form-group">
                <label for="userName" class="form-label">Full Name:</label>
                <input type="text" id="userName" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label for="userEmail" class="form-label">Email:</label>
                <input type="email" id="userEmail" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label for="userRole" class="form-label">Role:</label>
                <select id="userRole" class="form-control" required>
                    <option value="">-- Select Role --</option>
                    <option value="admin">Admin</option>
                    <option value="manager">Manager</option>
                    <option value="user">User</option>
                    <option value="guest">Guest</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="userOrganization" class="form-label">Organization:</label>
                <select id="userOrganization" class="form-control" required>
                    <option value="">-- Select Organization --</option>
                    <!-- Options will be populated dynamically -->
                </select>
            </div>
            
            <div class="form-group">
                <label for="userPassword" class="form-label">Password:</label>
                <input type="password" id="userPassword" class="form-control" required>
                <small class="form-text text-muted">Minimum 8 characters with letters and numbers</small>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary cancel-user-btn">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="modal">
    <div class="modal-content">
        <span class="modal-close">&times;</span>
        <h3>Confirm Delete</h3>
        
        <p>Are you sure you want to delete this user? This action cannot be undone.</p>
        
        <div class="form-actions">
            <button class="btn btn-secondary cancel-confirm-btn">Cancel</button>
            <button id="confirmDeleteBtn" class="btn btn-danger">Delete</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let users = [];
    let organizations = [];
    let currentUserId = null;
    
    onDOMReady(async () => {
        // Initialize the page
        await Promise.all([
            loadUsers(),
            loadOrganizations()
        ]);
        
        // Set up view toggle
        document.getElementById('listViewBtn').addEventListener('click', showListView);
        document.getElementById('treeViewBtn').addEventListener('click', showTreeView);
        
        // Set up search
        document.getElementById('searchBtn').addEventListener('click', searchUsers);
        document.getElementById('searchInput').addEventListener('keyup', event => {
            if (event.key === 'Enter') searchUsers();
        });
        
        // Set up add user button
        document.getElementById('addUserBtn').addEventListener('click', showAddUserModal);
        
        // Modal close buttons
        document.querySelectorAll('.modal-close, .cancel-user-btn').forEach(button => {
            button.addEventListener('click', () => {
                document.getElementById('userModal').style.display = 'none';
            });
        });
        
        document.querySelectorAll('.modal-close, .cancel-confirm-btn').forEach(button => {
            button.addEventListener('click', () => {
                document.getElementById('confirmModal').style.display = 'none';
            });
        });
        
        // Form submission
        document.getElementById('userForm').addEventListener('submit', handleSaveUser);
        
        // Confirm delete button
        document.getElementById('confirmDeleteBtn').addEventListener('click', handleDeleteUser);
        
        // Initialize feather icons
        if (typeof feather !== 'undefined') {
            feather.replace();
        }
    });
    
    async function loadUsers() {
        try {
            const response = await fetch('/users/list/');
            if (!response.ok) {
                throw new Error('Failed to load users');
            }
            
            users = await response.json();
            renderUserTable(users);
        } catch (error) {
            console.error('Error loading users:', error);
            
            // Sample data for demo
            users = [
                { id: 1, name: 'John Doe', email: 'john@example.com', role: 'admin', organization_id: 1 },
                { id: 2, name: 'Jane Smith', email: 'jane@example.com', role: 'manager', organization_id: 2 },
                { id: 3, name: 'Bob Johnson', email: 'bob@example.com', role: 'user', organization_id: 3 },
                { id: 4, name: 'Alice Williams', email: 'alice@example.com', role: 'guest', organization_id: 5 }
            ];
            
            renderUserTable(users);
        }
    }
    
    async function loadOrganizations() {
        try {
            const response = await fetch('/organisations/list/');
            if (!response.ok) {
                throw new Error('Failed to load organizations');
            }
            
            organizations = await response.json();
            
            // Build a hierarchical structure
            const orgMap = {};
            organizations.forEach(org => {
                org.children = [];
                orgMap[org.id] = org;
            });
            
            const rootOrgs = [];
            organizations.forEach(org => {
                if (org.parent_id && orgMap[org.parent_id]) {
                    orgMap[org.parent_id].children.push(org);
                } else {
                    rootOrgs.push(org);
                }
            });
            
            populateOrganizationDropdown(organizations);
            renderOrganizationTree(rootOrgs);
        } catch (error) {
            console.error('Error loading organizations:', error);
            
            // Sample data for demo
            organizations = [
                { id: 1, name: 'Root Organization', parent_id: null },
                { id: 2, name: 'Engineering', parent_id: 1 },
                { id: 3, name: 'Frontend Team', parent_id: 2 },
                { id: 4, name: 'Backend Team', parent_id: 2 },
                { id: 5, name: 'Marketing', parent_id: 1 }
            ];
            
            // Build a hierarchical structure
            const orgMap = {};
            organizations.forEach(org => {
                org.children = [];
                orgMap[org.id] = org;
            });
            
            const rootOrgs = [];
            organizations.forEach(org => {
                if (org.parent_id && orgMap[org.parent_id]) {
                    orgMap[org.parent_id].children.push(org);
                } else {
                    rootOrgs.push(org);
                }
            });
            
            populateOrganizationDropdown(organizations);
            renderOrganizationTree(rootOrgs);
        }
    }
    
    function renderUserTable(users) {
        const tableBody = document.getElementById('userTableBody');
        tableBody.innerHTML = '';
        
        if (!users || users.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center">No users found.</td></tr>';
            return;
        }
        
        users.forEach(user => {
            const organization = organizations.find(o => o.id === user.organization_id);
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <div class="user-item">
                        <div class="user-avatar">${getUserInitials(user.name)}</div>
                        <div class="user-name">${user.name}</div>
                    </div>
                </td>
                <td>${user.email}</td>
                <td><span class="role-badge role-${user.role}">${user.role}</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-primary edit-user" data-id="${user.id}">
                        <i data-feather="edit-2"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger delete-user" data-id="${user.id}">
                        <i data-feather="trash-2"></i>
                    </button>
                </td>
            `;
            
            tableBody.appendChild(row);
        });
        
        // Initialize feather icons
        if (typeof feather !== 'undefined') {
            feather.replace();
        }
        
        // Add event listeners
        document.querySelectorAll('.edit-user').forEach(button => {
            button.addEventListener('click', event => {
                const userId = parseInt(event.currentTarget.dataset.id);
                showEditUserModal(userId);
            });
        });
        
        document.querySelectorAll('.delete-user').forEach(button => {
            button.addEventListener('click', event => {
                const userId = parseInt(event.currentTarget.dataset.id);
                showDeleteConfirmation(userId);
            });
        });
    }
    
    function renderOrganizationTree(orgs) {
        const container = document.getElementById('userTreeContainer');
        container.innerHTML = '';
        
        if (!orgs || orgs.length === 0) {
            container.innerHTML = '<p>No organizations found.</p>';
            return;
        }
        
        function createTreeItem(org) {
            const hasChildren = org.children && org.children.length > 0;
            
            const treeItem = document.createElement('div');
            treeItem.className = 'tree-item';
            treeItem.dataset.id = org.id;
            
            const itemContent = document.createElement('div');
            itemContent.className = 'tree-item-content';
            
            // Toggle button for expandable items
            const toggleBtn = document.createElement('span');
            toggleBtn.className = 'tree-toggle';
            toggleBtn.innerHTML = hasChildren ? '<i data-feather="chevron-down"></i>' : '<span style="width: 20px;"></span>';
            itemContent.appendChild(toggleBtn);
            
            // Item label with icon
            const label = document.createElement('div');
            label.className = 'tree-label';
            label.innerHTML = `
                <i data-feather="briefcase" class="tree-icon"></i>
                <span>${org.name}</span>
            `;
            itemContent.appendChild(label);
            
            // Action button
            const actions = document.createElement('div');
            actions.className = 'd-flex';
            actions.innerHTML = `
                <button class="btn btn-sm btn-outline-primary add-user-to-org" data-id="${org.id}">
                    <i data-feather="user-plus"></i>
                </button>
            `;
            itemContent.appendChild(actions);
            
            treeItem.appendChild(itemContent);
            
            // Add users that belong to this organization
            const orgUsers = users.filter(u => u.organization_id === org.id);
            
            if (orgUsers.length > 0) {
                const usersList = document.createElement('div');
                usersList.className = 'org-users';
                
                orgUsers.forEach(user => {
                    const userItem = document.createElement('div');
                    userItem.className = 'org-user-item';
                    userItem.innerHTML = `
                        <div class="user-avatar small">${getUserInitials(user.name)}</div>
                        <div class="user-info">
                            <div class="user-name">${user.name}</div>
                            <div class="user-role">${user.role}</div>
                        </div>
                        <div class="user-actions">
                            <button class="btn btn-sm edit-user" data-id="${user.id}">
                                <i data-feather="edit-2"></i>
                            </button>
                            <button class="btn btn-sm delete-user" data-id="${user.id}">
                                <i data-feather="trash-2"></i>
                            </button>
                        </div>
                    `;
                    usersList.appendChild(userItem);
                });
                
                const usersContainer = document.createElement('div');
                usersContainer.className = 'org-users-container';
                usersContainer.appendChild(usersList);
                treeItem.appendChild(usersContainer);
            }
            
            // Add children if they exist
            if (hasChildren) {
                const childrenContainer = document.createElement('div');
                childrenContainer.className = 'tree-children';
                
                org.children.forEach(child => {
                    childrenContainer.appendChild(createTreeItem(child));
                });
                
                treeItem.appendChild(childrenContainer);
                
                // Add toggle functionality
                toggleBtn.addEventListener('click', () => {
                    childrenContainer.style.display = 
                        childrenContainer.style.display === 'none' ? 'block' : 'none';
                    toggleBtn.innerHTML = 
                        childrenContainer.style.display === 'none' ? 
                        '<i data-feather="chevron-right"></i>' : 
                        '<i data-feather="chevron-down"></i>';
                    
                    // Re-initialize feather icons
                    if (typeof feather !== 'undefined') {
                        feather.replace();
                    }
                });
            }
            
            return treeItem;
        }
        
        orgs.forEach(org => {
            container.appendChild(createTreeItem(org));
        });
        
        // Initialize feather icons
        if (typeof feather !== 'undefined') {
            feather.replace();
        }
        
        // Add event listeners
        document.querySelectorAll('.add-user-to-org').forEach(button => {
            button.addEventListener('click', event => {
                const orgId = parseInt(event.currentTarget.dataset.id);
                showAddUserToOrgModal(orgId);
            });
        });
        
        document.querySelectorAll('.edit-user').forEach(button => {
            button.addEventListener('click', event => {
                const userId = parseInt(event.currentTarget.dataset.id);
                showEditUserModal(userId);
            });
        });
        
        document.querySelectorAll('.delete-user').forEach(button => {
            button.addEventListener('click', event => {
                const userId = parseInt(event.currentTarget.dataset.id);
                showDeleteConfirmation(userId);
            });
        });
    }
    
    function populateOrganizationDropdown(orgs) {
        const dropdown = document.getElementById('userOrganization');
        
        // Keep the first option (placeholder)
        const firstOption = dropdown.options[0];
        dropdown.innerHTML = '';
        dropdown.appendChild(firstOption);
        
        // Add organizations as options
        orgs.forEach(org => {
            const option = document.createElement('option');
            option.value = org.id;
            option.textContent = org.name;
            dropdown.appendChild(option);
        });
    }
    
    function showListView() {
        document.getElementById('listViewBtn').classList.add('active');
        document.getElementById('treeViewBtn').classList.remove('active');
        
        document.getElementById('listView').style.display = 'block';
        document.getElementById('treeView').style.display = 'none';
    }
    
    function showTreeView() {
        document.getElementById('treeViewBtn').classList.add('active');
        document.getElementById('listViewBtn').classList.remove('active');
        
        document.getElementById('treeView').style.display = 'block';
        document.getElementById('listView').style.display = 'none';
    }
    
    function searchUsers() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        
        if (!searchTerm) {
            renderUserTable(users);
            return;
        }
        
        const filteredUsers = users.filter(user => 
            user.name.toLowerCase().includes(searchTerm) || 
            user.email.toLowerCase().includes(searchTerm) ||
            user.role.toLowerCase().includes(searchTerm)
        );
        
        renderUserTable(filteredUsers);
    }
    
    function showAddUserModal() {
        document.getElementById('userModalTitle').textContent = 'Add User';
        document.getElementById('userId').value = '';
        document.getElementById('userName').value = '';
        document.getElementById('userEmail').value = '';
        document.getElementById('userRole').value = '';
        document.getElementById('userOrganization').value = '';
        document.getElementById('userPassword').value = '';
        
        document.getElementById('userModal').style.display = 'block';
    }
    
    function showAddUserToOrgModal(orgId) {
        document.getElementById('userModalTitle').textContent = 'Add User to Organization';
        document.getElementById('userId').value = '';
        document.getElementById('userName').value = '';
        document.getElementById('userEmail').value = '';
        document.getElementById('userRole').value = '';
        document.getElementById('userOrganization').value = orgId;
        document.getElementById('userPassword').value = '';
        
        document.getElementById('userModal').style.display = 'block';
    }
    
    function showEditUserModal(userId) {
        const user = users.find(u => u.id === userId);
        if (!user) return;
        
        document.getElementById('userModalTitle').textContent = 'Edit User';
        document.getElementById('userId').value = user.id;
        document.getElementById('userName').value = user.name;
        document.getElementById('userEmail').value = user.email;
        document.getElementById('userRole').value = user.role;
        document.getElementById('userOrganization').value = user.organization_id || '';
        document.getElementById('userPassword').value = '********'; // Placeholder for password
        
        document.getElementById('userModal').style.display = 'block';
    }
    
    function showDeleteConfirmation(userId) {
        currentUserId = userId;
        document.getElementById('confirmModal').style.display = 'block';
    }
    
    async function handleSaveUser(event) {
        event.preventDefault();
        
        const userId = document.getElementById('userId').value;
        const name = document.getElementById('userName').value;
        const email = document.getElementById('userEmail').value;
        const role = document.getElementById('userRole').value;
        const organizationId = document.getElementById('userOrganization').value;
        const password = document.getElementById('userPassword').value;
        
        // Validate form
        if (!name || !email || !role || !organizationId || (!userId && !password)) {
            alert('Please fill in all required fields');
            return;
        }
        
        const userData = {
            name: name,
            email: email,
            role: role,
            organization_id: parseInt(organizationId)
        };
        
        if (password && password !== '********') {
            userData.password = password;
        }
        
        if (userId) {
            userData.id = parseInt(userId);
        }
        
        try {
            // In a real implementation, you would save to the server
            // const response = await fetch(userId ? `/users/${userId}/update/` : '/users/create/', {
            //     method: 'POST',
            //     headers: {
            //         'Content-Type': 'application/json',
            //         'X-CSRFToken': Helpers.getCsrfToken()
            //     },
            //     body: JSON.stringify(userData)
            // });
            
            // For demo purposes, simulate success
            if (userId) {
                // Update existing user
                const index = users.findIndex(u => u.id === parseInt(userId));
                if (index !== -1) {
                    users[index] = {
                        ...users[index],
                        name: name,
                        email: email,
                        role: role,
                        organization_id: parseInt(organizationId)
                    };
                }
            } else {
                // Add new user
                const newId = users.length > 0 ? Math.max(...users.map(u => u.id)) + 1 : 1;
                users.push({
                    id: newId,
                    name: name,
                    email: email,
                    role: role,
                    organization_id: parseInt(organizationId)
                });
            }
            
            // Close modal and refresh
            document.getElementById('userModal').style.display = 'none';
            renderUserTable(users);
            
            // Update tree view if it's active
            if (document.getElementById('treeView').style.display === 'block') {
                // Rebuild the tree
                const orgMap = {};
                organizations.forEach(org => {
                    org.children = [];
                    orgMap[org.id] = org;
                });
                
                const rootOrgs = [];
                organizations.forEach(org => {
                    if (org.parent_id && orgMap[org.parent_id]) {
                        orgMap[org.parent_id].children.push(org);
                    } else {
                        rootOrgs.push(org);
                    }
                });
                
                renderOrganizationTree(rootOrgs);
            }
            
            // Show success message
            const container = document.querySelector('.card-body');
            Helpers.showAlert(`User ${userId ? 'updated' : 'created'} successfully`, 'success', container);
        } catch (error) {
            console.error('Error saving user:', error);
            
            // Show error message
            const container = document.querySelector('.card-body');
            Helpers.showAlert('Error saving user. Please try again.', 'danger', container);
        }
    }
    
    async function handleDeleteUser() {
        if (!currentUserId) return;
        
        try {
            // In a real implementation, you would delete from the server
            // const response = await fetch(`/users/${currentUserId}/delete/`, {
            //     method: 'POST',
            //     headers: {
            //         'Content-Type': 'application/json',
            //         'X-CSRFToken': Helpers.getCsrfToken()
            //     }
            // });
            
            // For demo purposes, simulate success
            const index = users.findIndex(u => u.id === currentUserId);
            if (index !== -1) {
                users.splice(index, 1);
            }
            
            // Close modal and refresh
            document.getElementById('confirmModal').style.display = 'none';
            renderUserTable(users);
            
            // Update tree view if it's active
            if (document.getElementById('treeView').style.display === 'block') {
                // Rebuild the tree
                const orgMap = {};
                organizations.forEach(org => {
                    org.children = [];
                    orgMap[org.id] = org;
                });
                
                const rootOrgs = [];
                organizations.forEach(org => {
                    if (org.parent_id && orgMap[org.parent_id]) {
                        orgMap[org.parent_id].children.push(org);
                    } else {
                        rootOrgs.push(org);
                    }
                });
                
                renderOrganizationTree(rootOrgs);
            }
            
            // Show success message
            const container = document.querySelector('.card-body');
            Helpers.showAlert('User deleted successfully', 'success', container);
        } catch (error) {
            console.error('Error deleting user:', error);
            
            // Show error message
            const container = document.querySelector('.card-body');
            Helpers.showAlert('Error deleting user. Please try again.', 'danger', container);
        }
    }
    
    function getUserInitials(name) {
        if (!name) return '';
        
        const parts = name.split(' ');
        if (parts.length === 1) {
            return parts[0].charAt(0).toUpperCase();
        }
        
        return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
    }
</script>

<style>
    .ml-2 {
        margin-left: 10px;
    }
    
    .view-actions {
        display: flex;
        align-items: center;
    }
    
    .view-actions button:not(:last-child) {
        margin-right: 5px;
    }
    
    .user-item {
        display: flex;
        align-items: center;
    }
    
    .user-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background-color: var(--primary-color);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 10px;
    }
    
    .user-avatar.small {
        width: 28px;
        height: 28px;
        font-size: 0.8rem;
    }
    
    .role-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .role-admin {
        background-color: #e0f2fe;
        color: #0369a1;
    }
    
    .role-manager {
        background-color: #f0fdf4;
        color: #15803d;
    }
    
    .role-user {
        background-color: #eff6ff;
        color: #1d4ed8;
    }
    
    .role-guest {
        background-color: #f1f5f9;
        color: #64748b;
    }
    
    .tree-item {
        margin-bottom: 5px;
    }
    
    .tree-item-content {
        display: flex;
        align-items: center;
        padding: 8px 5px;
        border-radius: 4px;
    }
    
    .tree-item-content:hover {
        background-color: #f8fafc;
    }
    
    .tree-toggle {
        width: 20px;
        height: 20px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        margin-right: 5px;
    }
    
    .tree-label {
        flex: 1;
        display: flex;
        align-items: center;
    }
    
    .tree-icon {
        margin-right: 5px;
        color: var(--secondary-color);
    }
    
    .tree-children {
        margin-left: 25px;
        border-left: 1px solid var(--border-color);
        padding-left: 10px;
    }
    
    .org-users-container {
        margin-left: 25px;
        padding-left: 10px;
    }
    
    .org-users {
        margin-top: 5px;
        margin-bottom: 10px;
    }
    
    .org-user-item {
        display: flex;
        align-items: center;
        padding: 5px;
        border-radius: 4px;
    }
    
    .org-user-item:hover {
        background-color: #f8fafc;
    }
    
    .user-info {
        flex: 1;
        margin-left: 10px;
    }
    
    .user-role {
        font-size: 0.75rem;
        color: var(--secondary-color);
    }
    
    .user-actions {
        display: flex;
        gap: 5px;
    }
</style>
{% endblock %}