{% extends 'base.html' %}

{% block title %}Organizations - Access Control System{% endblock %}
{% block header_title %}Organizations{% endblock %}

{% block breadcrumb_items %}
<div class="breadcrumb-item">
    <a href="/" class="breadcrumb-link">Home</a>
</div>
<div class="breadcrumb-item">Organizations</div>
{% endblock %}

{% block page_title %}Organization Hierarchy{% endblock %}
{% block page_description %}Manage your organizational structure and departments{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <div></div>
    <button id="addOrgBtn" class="btn btn-primary">
        <i data-feather="plus" class="btn-icon"></i> Add Organization
    </button>
</div>

<div class="card">
    <div class="card-body">
        <div id="organization-tree" class="tree-view">
            <p>Loading organization hierarchy...</p>
        </div>
    </div>
</div>

<!-- Add/Edit Organization Modal -->
<div id="orgModal" class="modal">
    <div class="modal-content">
        <span class="modal-close">&times;</span>
        <h3 id="modalTitle">Add Organization</h3>
        
        <form id="organizationForm">
            <input type="hidden" id="orgId" value="">
            
            <div class="form-group">
                <label for="orgName" class="form-label">Organization Name:</label>
                <input type="text" id="orgName" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label for="parentOrg" class="form-label">Parent Organization:</label>
                <select id="parentOrg" class="form-control">
                    <option value="">-- None (Top Level) --</option>
                    <!-- Options will be populated dynamically -->
                </select>
            </div>
            
            <div class="form-group">
                <label for="orgLogo" class="form-label">Logo (optional):</label>
                <input type="file" id="orgLogo" class="form-control">
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary cancel-btn">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="modal">
    <div class="modal-content">
        <span class="modal-close">&times;</span>
        <h3>Confirm Delete</h3>
        
        <p>Are you sure you want to delete this organization? This action cannot be undone.</p>
        
        <div class="form-actions">
            <button class="btn btn-secondary cancel-btn">Cancel</button>
            <button id="confirmDeleteBtn" class="btn btn-danger">Delete</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let organizations = [];
    let currentOrgId = null;
    
    onDOMReady(async () => {
        // Initialize the page
        await loadOrganizations();
        
        // Set up event listeners
        document.getElementById('addOrgBtn').addEventListener('click', showAddOrgModal);
        
        // Modal close buttons
        document.querySelectorAll('.modal-close, .cancel-btn').forEach(button => {
            button.addEventListener('click', () => {
                document.getElementById('orgModal').style.display = 'none';
                document.getElementById('confirmModal').style.display = 'none';
            });
        });
        
        // Form submission
        document.getElementById('organizationForm').addEventListener('submit', handleSaveOrganization);
        
        // Confirm delete button
        document.getElementById('confirmDeleteBtn').addEventListener('click', handleDeleteOrganization);
        
        // Initialize feather icons
        if (typeof feather !== 'undefined') {
            feather.replace();
        }
    });
    
    async function loadOrganizations() {
        try {
            const response = await fetch('/organisations/list/');
            if (!response.ok) {
                throw new Error('Failed to load organizations');
            }
            
            organizations = await response.json();
            
            // Build a hierarchical structure
            const orgMap = {};
            organizations.forEach(org => {
                org.children = [];
                orgMap[org.id] = org;
            });
            
            const rootOrgs = [];
            organizations.forEach(org => {
                if (org.parent_id && orgMap[org.parent_id]) {
                    orgMap[org.parent_id].children.push(org);
                } else {
                    rootOrgs.push(org);
                }
            });
            
            renderOrganizationTree(rootOrgs);
            populateParentDropdown();
        } catch (error) {
            console.error('Error loading organizations:', error);
            
            // Show sample data for demo purposes
            const sampleOrgs = [
                { 
                    id: 1, 
                    name: 'Root Organization',
                    children: [
                        { 
                            id: 2, 
                            name: 'Engineering',
                            children: [
                                { id: 3, name: 'Frontend Team', children: [] },
                                { id: 4, name: 'Backend Team', children: [] }
                            ] 
                        },
                        { id: 5, name: 'Marketing', children: [] }
                    ]
                }
            ];
            
            renderOrganizationTree(sampleOrgs);
            
            // Add sample organizations to the global array for parent dropdown
            organizations = [
                { id: 1, name: 'Root Organization', parent_id: null },
                { id: 2, name: 'Engineering', parent_id: 1 },
                { id: 3, name: 'Frontend Team', parent_id: 2 },
                { id: 4, name: 'Backend Team', parent_id: 2 },
                { id: 5, name: 'Marketing', parent_id: 1 }
            ];
            
            populateParentDropdown();
        }
    }
    
    function renderOrganizationTree(orgs) {
        const container = document.getElementById('organization-tree');
        container.innerHTML = '';
        
        if (!orgs || orgs.length === 0) {
            container.innerHTML = '<p>No organizations found.</p>';
            return;
        }
        
        function createTreeItem(org) {
            const hasChildren = org.children && org.children.length > 0;
            
            const treeItem = document.createElement('div');
            treeItem.className = 'tree-item';
            treeItem.dataset.id = org.id;
            
            const itemContent = document.createElement('div');
            itemContent.className = 'tree-item-content';
            
            // Toggle button for expandable items
            const toggleBtn = document.createElement('span');
            toggleBtn.className = 'tree-toggle';
            toggleBtn.innerHTML = hasChildren ? '<i data-feather="chevron-down"></i>' : '<span style="width: 20px;"></span>';
            itemContent.appendChild(toggleBtn);
            
            // Item label with icon
            const label = document.createElement('div');
            label.className = 'tree-label';
            label.innerHTML = `
                <i data-feather="briefcase" class="tree-icon"></i>
                <span>${org.name}</span>
                <span style="margin-left: 10px; color: var(--secondary-color); font-size: 0.8rem;">
                    ${org.user_count ? org.user_count + ' user' + (org.user_count > 1 ? 's' : '') : ''}
                </span>
            `;
            itemContent.appendChild(label);
            
            // Action buttons
            const actions = document.createElement('div');
            actions.className = 'd-flex';
            actions.innerHTML = `
                <button class="btn btn-sm" title="Add Child" data-action="add" data-id="${org.id}">
                    <i data-feather="plus"></i>
                </button>
                <button class="btn btn-sm" title="Edit" data-action="edit" data-id="${org.id}">
                    <i data-feather="edit-2"></i>
                </button>
                <button class="btn btn-sm" title="Delete" data-action="delete" data-id="${org.id}">
                    <i data-feather="trash-2"></i>
                </button>
            `;
            itemContent.appendChild(actions);
            
            treeItem.appendChild(itemContent);
            
            // Add children if they exist
            if (hasChildren) {
                const childrenContainer = document.createElement('div');
                childrenContainer.className = 'tree-children';
                
                org.children.forEach(child => {
                    childrenContainer.appendChild(createTreeItem(child));
                });
                
                treeItem.appendChild(childrenContainer);
                
                // Add toggle functionality
                toggleBtn.addEventListener('click', () => {
                    childrenContainer.style.display = 
                        childrenContainer.style.display === 'none' ? 'block' : 'none';
                    toggleBtn.innerHTML = 
                        childrenContainer.style.display === 'none' ? 
                        '<i data-feather="chevron-right"></i>' : 
                        '<i data-feather="chevron-down"></i>';
                    
                    // Re-initialize feather icons
                    if (typeof feather !== 'undefined') {
                        feather.replace();
                    }
                });
            }
            
            return treeItem;
        }
        
        orgs.forEach(org => {
            container.appendChild(createTreeItem(org));
        });
        
        // Initialize feather icons
        if (typeof feather !== 'undefined') {
            feather.replace();
        }
        
        // Add event listeners for action buttons
        container.querySelectorAll('[data-action]').forEach(button => {
            button.addEventListener('click', (e) => {
                const action = e.currentTarget.dataset.action;
                const orgId = parseInt(e.currentTarget.dataset.id);
                
                if (action === 'add') {
                    showAddChildModal(orgId);
                } else if (action === 'edit') {
                    showEditOrgModal(orgId);
                } else if (action === 'delete') {
                    showDeleteConfirmation(orgId);
                }
            });
        });
    }
    
    function populateParentDropdown() {
        const dropdown = document.getElementById('parentOrg');
        
        // Clear existing options (except the first one)
        const firstOption = dropdown.options[0];
        dropdown.innerHTML = '';
        dropdown.appendChild(firstOption);
        
        // Add each organization as an option
        organizations.forEach(org => {
            const option = document.createElement('option');
            option.value = org.id;
            option.textContent = org.name;
            dropdown.appendChild(option);
        });
    }
    
    function showAddOrgModal() {
        document.getElementById('modalTitle').textContent = 'Add Organization';
        document.getElementById('orgId').value = '';
        document.getElementById('orgName').value = '';
        document.getElementById('parentOrg').value = '';
        document.getElementById('orgLogo').value = '';
        
        document.getElementById('orgModal').style.display = 'block';
    }
    
    function showAddChildModal(parentId) {
        document.getElementById('modalTitle').textContent = 'Add Child Organization';
        document.getElementById('orgId').value = '';
        document.getElementById('orgName').value = '';
        document.getElementById('parentOrg').value = parentId;
        document.getElementById('orgLogo').value = '';
        
        document.getElementById('orgModal').style.display = 'block';
    }
    
    function showEditOrgModal(orgId) {
        const org = organizations.find(o => o.id === orgId);
        if (!org) return;
        
        document.getElementById('modalTitle').textContent = 'Edit Organization';
        document.getElementById('orgId').value = org.id;
        document.getElementById('orgName').value = org.name;
        document.getElementById('parentOrg').value = org.parent_id || '';
        
        // Remove the organization from parent options (to prevent circular references)
        const dropdown = document.getElementById('parentOrg');
        for (let i = 0; i < dropdown.options.length; i++) {
            if (dropdown.options[i].value === String(org.id)) {
                dropdown.options[i].disabled = true;
            } else {
                dropdown.options[i].disabled = false;
            }
        }
        
        document.getElementById('orgModal').style.display = 'block';
    }
    
    function showDeleteConfirmation(orgId) {
        currentOrgId = orgId;
        document.getElementById('confirmModal').style.display = 'block';
    }
    
    async function handleSaveOrganization(event) {
        event.preventDefault();
        
        const orgId = document.getElementById('orgId').value;
        const orgName = document.getElementById('orgName').value;
        const parentId = document.getElementById('parentOrg').value;
        const logoFile = document.getElementById('orgLogo').files[0];
        
        const formData = new FormData();
        formData.append('name', orgName);
        if (parentId) formData.append('parent_id', parentId);
        if (logoFile) formData.append('logo', logoFile);
        
        try {
            let url = '/organisations/create/';
            let method = 'POST';
            
            if (orgId) {
                url = `/organisations/${orgId}/update/`;
                method = 'POST';
            }
            
            const response = await fetch(url, {
                method: method,
                body: formData,
                headers: {
                    'X-CSRFToken': Helpers.getCsrfToken()
                }
            });
            
            if (!response.ok) {
                throw new Error('Failed to save organization');
            }
            
            // Close the modal and reload organizations
            document.getElementById('orgModal').style.display = 'none';
            await loadOrganizations();
            
            // Show success message
            const container = document.querySelector('.card-body');
            Helpers.showAlert(`Organization ${orgId ? 'updated' : 'created'} successfully`, 'success', container);
        } catch (error) {
            console.error('Error saving organization:', error);
            
            // For demo purposes, simulate success
            document.getElementById('orgModal').style.display = 'none';
            
            // Update the sample data if in demo mode
            if (organizations[0].id === 1 && organizations[0].name === 'Root Organization') {
                if (!orgId) {
                    // Add new org
                    const newId = organizations.length + 1;
                    organizations.push({
                        id: newId,
                        name: orgName,
                        parent_id: parentId ? parseInt(parentId) : null
                    });
                } else {
                    // Update existing org
                    const orgIndex = organizations.findIndex(o => o.id === parseInt(orgId));
                    if (orgIndex !== -1) {
                        organizations[orgIndex].name = orgName;
                        organizations[orgIndex].parent_id = parentId ? parseInt(parentId) : null;
                    }
                }
                
                // Rebuild the hierarchy and re-render
                const orgMap = {};
                organizations.forEach(org => {
                    org.children = [];
                    orgMap[org.id] = org;
                });
                
                const rootOrgs = [];
                organizations.forEach(org => {
                    if (org.parent_id && orgMap[org.parent_id]) {
                        orgMap[org.parent_id].children.push(org);
                    } else {
                        rootOrgs.push(org);
                    }
                });
                
                renderOrganizationTree(rootOrgs);
                populateParentDropdown();
            }
            
            // Show success message for demo
            const container = document.querySelector('.card-body');
            Helpers.showAlert(`Organization ${orgId ? 'updated' : 'created'} successfully`, 'success', container);
        }
    }
    
    async function handleDeleteOrganization() {
        if (!currentOrgId) return;
        
        try {
            const response = await fetch(`/organisations/${currentOrgId}/delete/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': Helpers.getCsrfToken()
                }
            });
            
            if (!response.ok) {
                throw new Error('Failed to delete organization');
            }
            
            // Close the modal and reload organizations
            document.getElementById('confirmModal').style.display = 'none';
            await loadOrganizations();
            
            // Show success message
            const container = document.querySelector('.card-body');
            Helpers.showAlert('Organization deleted successfully', 'success', container);
        } catch (error) {
            console.error('Error deleting organization:', error);
            
            // For demo purposes, simulate success
            document.getElementById('confirmModal').style.display = 'none';
            
            // Remove from sample data if in demo mode
            if (organizations[0].id === 1 && organizations[0].name === 'Root Organization') {
                // Find and remove the organization
                const orgIndex = organizations.findIndex(o => o.id === currentOrgId);
                if (orgIndex !== -1) {
                    organizations.splice(orgIndex, 1);
                    
                    // Rebuild the hierarchy and re-render
                    const orgMap = {};
                    organizations.forEach(org => {
                        org.children = [];
                        orgMap[org.id] = org;
                    });
                    
                    const rootOrgs = [];
                    organizations.forEach(org => {
                        if (org.parent_id && orgMap[org.parent_id]) {
                            orgMap[org.parent_id].children.push(org);
                        } else {
                            rootOrgs.push(org);
                        }
                    });
                    
                    renderOrganizationTree(rootOrgs);
                    populateParentDropdown();
                }
            }
            
            // Show success message for demo
            const container = document.querySelector('.card-body');
            Helpers.showAlert('Organization deleted successfully', 'success', container);
        }
    }
</script>

<style>
    .tree-item {
        margin-bottom: 5px;
    }
    
    .tree-item-content {
        display: flex;
        align-items: center;
        padding: 8px 5px;
        border-radius: 4px;
    }
    
    .tree-item-content:hover {
        background-color: #f8fafc;
    }
    
    .tree-toggle {
        width: 20px;
        height: 20px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        margin-right: 5px;
    }
    
    .tree-label {
        flex: 1;
        display: flex;
        align-items: center;
    }
    
    .tree-icon {
        margin-right: 5px;
        color: var(--secondary-color);
    }
    
    .tree-children {
        margin-left: 25px;
        border-left: 1px solid var(--border-color);
        padding-left: 10px;
    }
</style>
{% endblock %}