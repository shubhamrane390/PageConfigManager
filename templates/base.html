<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Access Control System{% endblock %}</title>
    
    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/styles.css">
    
    {% block extra_css %}{% endblock %}
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i data-feather="shield"></i>
                    <span>Access Control</span>
                </div>
                <button class="sidebar-toggle">
                    <i data-feather="menu"></i>
                </button>
            </div>
            
            <nav class="sidebar-nav">
                <a href="/" class="sidebar-nav-link" data-page="dashboard">
                    <i data-feather="grid" class="sidebar-nav-icon"></i>
                    <span>Dashboard</span>
                </a>
                <a href="/organisations/" class="sidebar-nav-link" data-page="organisations">
                    <i data-feather="briefcase" class="sidebar-nav-icon"></i>
                    <span>Organizations</span>
                </a>
                <a href="/location_hierarchy/" class="sidebar-nav-link" data-page="location_hierarchy">
                    <i data-feather="map-pin" class="sidebar-nav-icon"></i>
                    <span>Location Hierarchy</span>
                </a>
                <a href="/users/" class="sidebar-nav-link" data-page="users">
                    <i data-feather="users" class="sidebar-nav-icon"></i>
                    <span>Users</span>
                </a>
                <a href="/permissions/" class="sidebar-nav-link" data-page="permissions">
                    <i data-feather="shield" class="sidebar-nav-icon"></i>
                    <span>Permissions</span>
                </a>
                <a href="/configuration/" class="sidebar-nav-link" data-page="configuration">
                    <i data-feather="settings" class="sidebar-nav-icon"></i>
                    <span>Configuration</span>
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar">JD</div>
                    <div class="user-details">
                        <div class="user-name">John Doe</div>
                        <div class="user-role">Administrator</div>
                    </div>
                </div>
                <div class="user-actions">
                    <button class="btn-icon" title="Settings">
                        <i data-feather="settings"></i>
                    </button>
                    <button class="btn-icon" title="Logout">
                        <i data-feather="log-out"></i>
                    </button>
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-content">
                    <h1 class="header-title">{% block header_title %}Dashboard{% endblock %}</h1>
                    <div class="breadcrumb">
                        {% block breadcrumb_items %}
                        <div class="breadcrumb-item">
                            <a href="/" class="breadcrumb-link">Home</a>
                        </div>
                        <div class="breadcrumb-item">Dashboard</div>
                        {% endblock %}
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn-icon" title="Notifications">
                        <i data-feather="bell"></i>
                    </button>
                    <button class="btn-icon" title="Help">
                        <i data-feather="help-circle"></i>
                    </button>
                </div>
            </header>
            
            <!-- Page Content -->
            <div class="page-content">
                <div class="page-header">
                    <div class="page-title-section">
                        <h2 class="page-title">{% block page_title %}Dashboard{% endblock %}</h2>
                        <p class="page-description">{% block page_description %}Overview of your system{% endblock %}</p>
                    </div>
                </div>
                
                <div class="content-container">
                    {% block content %}{% endblock %}
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modal Container -->
    <div class="modal-container"></div>
    
    <!-- Common JavaScript -->
    <script>
        // Initialize Feather Icons
        document.addEventListener('DOMContentLoaded', () => {
            feather.replace();
            
            // Sidebar toggle for mobile
            const sidebarToggle = document.querySelector('.sidebar-toggle');
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', () => {
                    document.querySelector('.app-container').classList.toggle('sidebar-collapsed');
                });
            }
            
            // Set active link in sidebar
            const currentPath = window.location.pathname;
            document.querySelectorAll('.sidebar-nav-link').forEach(link => {
                if (link.getAttribute('href') === currentPath) {
                    link.classList.add('active');
                } else if (currentPath !== '/' && link.getAttribute('href') !== '/' && currentPath.includes(link.getAttribute('href'))) {
                    link.classList.add('active');
                }
            });
        });
        
        // Helper functions
        const Helpers = {
            /**
             * Shows an alert message
             * @param {string} message - Message to display
             * @param {string} type - Alert type (success, danger, warning)
             * @param {HTMLElement} container - Container to append the alert to
             */
            showAlert: function(message, type = 'success', container = document.body) {
                const alert = document.createElement('div');
                alert.className = `alert alert-${type}`;
                alert.innerHTML = `
                    <div class="alert-content">
                        <div class="alert-icon">
                            <i data-feather="${type === 'success' ? 'check-circle' : type === 'danger' ? 'alert-circle' : 'alert-triangle'}"></i>
                        </div>
                        <div class="alert-message">${message}</div>
                    </div>
                    <button class="alert-close">&times;</button>
                `;
                
                container.prepend(alert);
                
                // Initialize icons
                feather.replace();
                
                // Add close button event
                alert.querySelector('.alert-close').addEventListener('click', () => {
                    alert.remove();
                });
                
                // Auto remove after 5 seconds
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.classList.add('alert-fade-out');
                        setTimeout(() => {
                            if (alert.parentNode) {
                                alert.remove();
                            }
                        }, 500);
                    }
                }, 5000);
            },
            
            /**
             * Shows a loading overlay
             * @param {string} message - Loading message to display
             */
            showLoading: function(message = 'Loading...') {
                const loading = document.createElement('div');
                loading.className = 'loading-overlay';
                loading.innerHTML = `
                    <div class="loading-content">
                        <div class="loading-spinner"></div>
                        <div class="loading-message">${message}</div>
                    </div>
                `;
                
                document.body.appendChild(loading);
                document.body.classList.add('loading');
            },
            
            /**
             * Hides the loading overlay
             */
            hideLoading: function() {
                const loading = document.querySelector('.loading-overlay');
                if (loading) {
                    loading.remove();
                    document.body.classList.remove('loading');
                }
            },
            
            /**
             * Makes an API request
             * @param {string} url - API endpoint
             * @param {Object} options - Fetch options
             * @returns {Promise} - Fetch promise
             */
            fetchAPI: async function(url, options = {}) {
                const defaultOptions = {
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCsrfToken()
                    }
                };
                
                const fetchOptions = {...defaultOptions, ...options};
                
                try {
                    const response = await fetch(url, fetchOptions);
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => null);
                        throw new Error(errorData?.message || `HTTP Error: ${response.status}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('API Error:', error);
                    throw error;
                }
            },
            
            /**
             * Gets the CSRF token from cookies
             * @returns {string} - CSRF token
             */
            getCsrfToken: function() {
                const name = 'csrftoken';
                const cookieValue = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
                return cookieValue ? cookieValue.pop() : '';
            },
            
            /**
             * Validates a form
             * @param {HTMLFormElement} form - Form to validate
             * @returns {boolean} - Whether the form is valid
             */
            validateForm: function(form) {
                let isValid = true;
                
                // Remove existing validation messages
                form.querySelectorAll('.validation-message').forEach(el => el.remove());
                form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
                
                // Check each required field
                form.querySelectorAll('[required]').forEach(field => {
                    if (!field.value.trim()) {
                        this.addValidationMessage(field, 'This field is required');
                        isValid = false;
                    }
                });
                
                // Check email fields
                form.querySelectorAll('input[type="email"]').forEach(field => {
                    if (field.value.trim() && !this.isValidEmail(field.value)) {
                        this.addValidationMessage(field, 'Please enter a valid email address');
                        isValid = false;
                    }
                });
                
                return isValid;
            },
            
            /**
             * Adds a validation message to a field
             * @param {HTMLElement} field - Field to add validation message to
             * @param {string} message - Validation message
             */
            addValidationMessage: function(field, message) {
                field.classList.add('is-invalid');
                
                const validationMessage = document.createElement('div');
                validationMessage.className = 'validation-message';
                validationMessage.textContent = message;
                
                field.parentNode.appendChild(validationMessage);
            },
            
            /**
             * Checks if an email is valid
             * @param {string} email - Email to check
             * @returns {boolean} - Whether the email is valid
             */
            isValidEmail: function(email) {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            },
            
            /**
             * Formats a date
             * @param {string} dateString - Date string
             * @returns {string} - Formatted date
             */
            formatDate: function(dateString) {
                const date = new Date(dateString);
                return new Intl.DateTimeFormat('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                }).format(date);
            }
        };
        
        // DOM ready handler helper
        function onDOMReady(callback) {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', callback);
            } else {
                callback();
            }
        }
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>